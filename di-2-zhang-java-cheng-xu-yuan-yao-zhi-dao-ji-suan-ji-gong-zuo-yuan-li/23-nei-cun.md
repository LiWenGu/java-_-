# 它是跑程序的地方

---

## 3.1 内存和程序
内存在程序中一直处于主导地位，它是磁盘存储与 `CPU` 之间的一座“缓冲区桥梁”，它与 `CPU` 通信的速度是磁盘与 `CPU` 通信的千倍以上，它几乎没有 `IOPS` 的概念，带宽也是几十 G 每秒。从容量上讲，它拥有比 `CPU` 的缓存大出几百倍、几千倍的空间来存储程序和数据，现代的 `PC` 上大多也已经是 `8G` 、 `16G` 或者更高的配置在运行系统，内存的大小在一些场景下可以决定计算机的整体能力。  
  
前文中提到， `CPU` 的 `Cache` 比起访问内存效率更高，主要体现在延迟上，因为内存距离 `CPU` 有一段距离。但通常系统都有大量的程序和数据需要计算， `CPU` 的 `Cache` 大小虽然也在不断变大，但目前来讲都是以 `MB` 为单位，目前最大的三级缓存大小也不过几十 `MB` （以及缓存和二级缓存相对较少），如果缓存变得过大，又会向内存那样设计各种复杂的算法来管理了。   
  
使用磁盘虽然可以存储比内存更多的数据，但是需要经过主板的喝多步骤才能到达 `CPU` 。另外，机械硬盘的 `IOPS` 本身就很低，即使 `SSD` 硬盘，安装在原先的 `SATA` 接口上，由于宽带的限制也很难达到理想中的高效。  
  
内存的容量都是以 `GB` 为单位的，带宽也非常高，大量的程序运行时都依赖于内存来存储，由 `OS` 来管理和调度。  
  
以 32 位 `OS` 为例：最基础的是物理地址，系统会为每个内存单元编写一些物理地址（它是地址总线上的对应关系，每个地址位的 0|1 都可以表达出不同的地址），物理地址可以认为是唯一的，它由内存本身的电路来控制。  
  
所有的“程序中”使用额地址都是虚拟地址，这些地址在不同的进程之间是可以重复的，所以才叫虚拟地址（你是你们班的第五名，也有其他班的第五名，但是学号是唯一的）。
  
## 3.2 `CPU` 的分页机制
如果没有使用分页机制，那么每个程序会有一个“段”的概念，也就是为进程分配的一段内存区，它的起始位置+逻辑地址（此时逻辑地址就像偏移量一样）得到线性地址，而此时由于每个程序段是单独的一块连续区域，因此线性地址就是物理地址。  
  
若一个进程访问的不是“本进程的内存”，那么就会出现问题。现代 `CPU` 启动了分页模型，以支撑较大的内存，分页模型会将内存区域划分成较小的页，物理上大多将其划分为 4KB /页，要管理这些页就需要一些管理者。  
  
系统会为每个进程分配页目录，这个页目录也是一个页（大小也是 `4KB` ），这些页是由 `Kernel` 来管理的（因此 `Kernel` 需要单独的区域，程序所使用地址并不是从 0 开始的），当通过一个虚拟地址访问内存时，会寻找对应进程的页目录的地址，加载到 `CR3` 寄存器中。  
  
找到页目录后做什么呢？页目录是 4KB 大小，在 32 位系统中，每 4 字节可以存放一个地址，可以存放 0~1023 共 1024 个地址，因此传入的逻辑地址只需要 10 位就可以定位到一个页目录中一个保存地址的单位（32 位中的高 10 位（1023=BIN 10 0000 0000）），这个单位存储的地址就是“页表”的地址。
  
页表本身也是一个页，大小也是 4KB （有 1024 个页表，所以页表总大小为 4MB ），每个也存储了 1024 个地址，因此逻辑地址中的中间 10 个二进制位就可以标志出页表中的对应单元（每4个字节为一个标志地址的单元）。页表中的这个单元也许不一定是物理页，可能还需要经过一层转换后才能得到物理页。  
 
## 3.3 进程申请内存
当一个进程需要申请“一次”分配内存时，操作系统会分配一块连续的虚拟地址内存给它。当然，进程可以多次向操作系统申请内存空间，这些空间最终和进程所对应的页表映射起来，所以当进程退出后，这些资源都会被释放。   
  
在 `Java` 语言中，主要是看 `Heap` 区域，当系统参数设置为 `-Xms、-Xmx` 时， `JVM` 通常是申请一个连续的虚拟地址，也就是 `Java` 申请一块大内存，通过 `OS` 预先分配的实际物理内存空间是 `-Xms` 的大小，但是 `OS` 未必会立即分配一个 `-Xms` 大小的空间给 `JVM` 使用，许多空间也是到真正使用时才分配的（`-Xmx` 不行，它是设置 `JVM` 的最大内存）。
>进程向 `OS` 申请的内存空间首先会从 `Free` 状态到 `Reserved` 状态，这种状态仅仅是占用了一个坑，但是还没有真正用这个内存空阿金，真正用的内存页的状态为 `Commited`。（很多设计都体现了这种思想，像数据库业务的事务最后需要 `Commited` ，以及 `I/O` 写入磁盘需要最后 `flush` ）。
