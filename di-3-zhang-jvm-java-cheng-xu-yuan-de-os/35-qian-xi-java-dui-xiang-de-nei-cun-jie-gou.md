## 5.1 原始类型与对象的自动拆装箱

常见的基本类型： `boolean` 、 `byte` 、 `short` 、 `int` 、 `long` 、 `float` 、 `double` 、 `char` 。例如， `int` 的自动装箱使用 `Integer.valueOf()` 来实现，它在编译阶段就完成了这样一个简单转换。

```java
int size = 100 * 1024 * 1024;
int[] values = new int[size];
for(int i = 0; i < size; i++) {
    values[i] = i;
}
```

```java
Integer values = new Integer[size];
for(int i = 0; i < size; i++){
    values[i] = i;
}
```

第二段代码的数组的大小应当等于数组本身占用空间 + `size` \* `Integer` 对象占用空间。  
![][1]  
那么一个 `Integer` 对象占用多大内存呢？

## 5.2 对象内存结构

一个对象本身的内在结构的描述信息是以字节码的方式存储在方法区当中的，当申请分配对象时，每一个对象实体是否还需要对象的描述信息呢？  
1： `Class` 本身就是一个对象，都以 `KB` 为单位，如果 `new Integer()` 为了表示一个数字就占用 `KB` 级别的内存能接受吗？因为一个 `int` 才 4 个字节。  
2： 而字节码增强技术，如果对象的结构发生改变，要让每个对象都感知到，如果大家都有一份 `Class` 拷贝，要修改这些拷贝是多么痛苦的事情（虽然不是我们做）。

但为了表示对象的属性、方法等信息，不得不需要这个结构描述。于是， `Hotspot VM` 使用对象头部的一个指针指向 `Class` 区域的方式来找到对象的 `Class` 描述，以及内部的方法、属性入口。不过，大家需要注意的是，对象头部不止存储这些内容，它通常还会存放：是否加锁、 `GC` 标志位、`Monir GC` 次数、对象默认的 `hashCode(System.identityHash Code(o)可获取对象的这个值)` 等信息。其实只用 0 、 1 二进制就可以表达是与否，它们也是类似的，例如存放锁标记可能只需要 1~2 个二进制就可以表达，所以也并不需要太大的空间（这部分空间通常叫作 `Mark Word` ）。

`Java` 对象将以 8 字节对齐在内存中，也就是对象占用的空间不是 8 字节的倍数，将会被补齐为 8 字节的倍数，好处自然是在对象分配和查找的过程中不用考虑过多的偏移量问题（使用 UTF-16 也是这个道理）。  
![][2]
当使用 `new Object()` 时（其实这个对象里面什么属性都没有）， `JVM` 将会分配 8 字节的空间， 128 个 `Object` 对象将占用 1 `KB` 的空间。  
如果是 `new Integer()` 那么对象里面将包含一个 `int` 值，占用 4 个字节，对象此时是 12 个字节，按照对象 8 字节对齐的说法，它将对齐到 16 字节。

那么第二段代码的大小为：size \* 16（每个16字节） = 100 \* 1024 \* 1024 \* 16 = 1600MB 的多余开销。而原始数组也会有开销：  
1. 8 字节头部。  
2. 4 字节描述数组长度。  
3. 100MB \* 4 = 400MB。  
即第一段代码占用 400MB 的空间，第二段代码占用 1600MB + 400MB = 2GB 的空间。

## 5.3 对象嵌套

> 顺便再说下 `GC` 的问题：早期的 `JVM` 垃圾回收中使用引用计数法回收时，对于对象出现了虚幻嵌套的情况是毫无办法的，不过现在 `GC` 只需要找活着的对象，就不会有这个问题。  

![][3]

## 5.4 int[2][100] PK int[100][2]
前者：
1. 8 字节：对象头部
2. 4 字节：数组长度描述
3. 2*4 = 8 字节： 引用宽度
4. 4 字节： padding
5. 合计 24 字节。
6. 两个子数组：
7. 8 字节：对象头部
8. 4 字节：数组长度描述
9. 100*4 = 400 字节，每个元素为一个 `int` 宽度。
10. 4字节：padding。
11. 合计 416 字节。
12. 总共： 24 + 2 * 416 = 856 字节。  
  
后者：
1. 8 字节：对象头部。
2. 4 字节： 数组长度描述。
3. 100*4 = 400 字节：引用宽度。
4. 4 字节：padding。
5. 合计 416 字节。
6. 100 个子数组：
7. 8 字节：对象头部。
8. 4 字节：数组长度描述。
9. 2*4 = 8 字节：两个 `int` 的宽度。
10. 4 字节：padding。
11. 合计：24 字节。
12. 总共：416 + 100 * 24 = 2816 字节。


[1]: /assets/3-5-1.png
[2]: /assets/3-5-2.png
[3]: /assets/3-5-3.png

